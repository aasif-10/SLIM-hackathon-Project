<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anomaly | SLIM AI</title>
  <link rel="stylesheet" href="css/design-system.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <script src="js/components.js"></script>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>

<body>
  <div id="app-nav" style="display: contents;"></div>

  <main class="main-content">
    <header class="top-bar">
      <div class="page-title">Anomaly Lab</div>
      <div class="flex items-center gap-2">
        <span class="badge badge-neutral">Detector: Isolation Forest</span>
      </div>
    </header>

    <div class="scroll-area">
      <div class="container">

        <!-- Stats Row -->
        <div class="grid-4 mb-4">
          <div class="card">
            <div class="text-muted label">Critical Anomalies</div>
            <div class="value text-danger" id="critical-count" style="font-size:1.5rem; font-weight:700;">--</div>
          </div>
          <div class="card">
            <div class="text-muted label">Warnings</div>
            <div class="value text-warning" id="warning-count" style="font-size:1.5rem; font-weight:700;">--</div>
          </div>
          <div class="card">
            <div class="text-muted label">Normal Readings</div>
            <div class="value text-success" id="normal-count" style="font-size:1.5rem; font-weight:700;">--</div>
          </div>
          <div class="card">
            <div class="text-muted label">Detection Rate</div>
            <div class="value text-primary" style="font-size:1.5rem; font-weight:700;">11.5%</div>
          </div>
        </div>

        <!-- Main Viz -->
        <div class="grid-1 mb-4">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Sensor Network Heatmap (Last 24h)</div>
            </div>
            <div id="heatmap-chart" style="height: 400px; width:100%;"></div>
          </div>
        </div>

        <!-- Secondary Viz Row -->
        <div class="grid-2 mb-4">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Anomaly Events Timeline</div>
            </div>
            <div id="timeline-chart" style="height: 300px; width:100%;"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Parameter Correlations</div>
            </div>
            <div id="correlation-chart" style="height: 300px; width:100%;"></div>
          </div>
        </div>

        <!-- Status Chips -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Current Sensor Status</div>
          </div>
          <div id="anomaly-results" class="flex flex-wrap gap-4"></div>
        </div>

      </div>
    </div>
  </main>

  <script src="js/components.js"></script>
  <script>initPage('anomaly');</script>

  <script>
    // V3 Theme Colors
    const theme = {
      bg: '#ffffff',
      surface: '#ffffff',
      text: '#0f172a',
      muted: '#64748b',
      border: '#e2e8f0',
      primary: '#3b82f6',
      success: '#10b981',
      warning: '#f59e0b',
      danger: '#ef4444'
    };

    const sensors = ['S-01 North', 'S-02 East', 'S-03 Central', 'S-04 South', 'S-05 West', 'S-06 Outlet'];
    const hours = [];
    for (let i = 23; i >= 0; i--) {
      const h = new Date();
      h.setHours(h.getHours() - i);
      hours.push(h.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
    }

    // Mock Data Generation
    function generateAnomalyData() {
      const data = [];
      sensors.forEach((sensor) => {
        const row = [];
        hours.forEach(() => {
          let score = 0;
          const rand = Math.random();
          if (sensor.includes('S-04')) {
            if (rand > 0.6) score = 1; if (rand > 0.8) score = 2; if (rand > 0.92) score = 3;
          } else if (sensor.includes('S-03')) {
            if (rand > 0.75) score = 1; if (rand > 0.9) score = 2; if (rand > 0.97) score = 3;
          } else {
            if (rand > 0.85) score = 1; if (rand > 0.95) score = 2;
          }
          row.push(score);
        });
        data.push(row);
      });
      return data;
    }
    const anomalyData = generateAnomalyData();

    function renderHeatmap() {
      const trace = {
        z: anomalyData,
        x: hours,
        y: sensors,
        type: 'heatmap',
        colorscale: [
          [0, '#dcfce7'], // success-ish light
          [0.33, '#86efac'],
          [0.5, '#fde047'], // warning-ish
          [0.75, '#fb923c'],
          [1, '#f87171'] // danger-ish
        ],
        showscale: true,
      };

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter, sans-serif', color: theme.text },
        margin: { l: 80, r: 20, t: 20, b: 50 },
        xaxis: { tickangle: -45, gridcolor: 'transparent' },
        yaxis: { gridcolor: 'transparent' }
      };

      Plotly.newPlot('heatmap-chart', [trace], layout, { responsive: true, displayModeBar: false });
    }

    function renderTimeline() {
      // Aggregate counts
      const counts = [];
      hours.forEach((_, hIdx) => {
        let count = 0;
        sensors.forEach((_, sIdx) => { if (anomalyData[sIdx][hIdx] > 0) count++; });
        counts.push(count);
      });

      const trace = {
        x: hours,
        y: counts,
        type: 'bar',
        marker: { color: theme.primary },
      };

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter, sans-serif', color: theme.text },
        margin: { l: 40, r: 20, t: 20, b: 60 },
        xaxis: { tickangle: -45 },
        yaxis: { gridcolor: theme.border, title: 'Sensors Affected' }
      };

      Plotly.newPlot('timeline-chart', [trace], layout, { responsive: true, displayModeBar: false });
    }

    function renderCorrelation() {
      const params = ['pH', 'Turbd', 'Temp', 'DO'];
      const z = [
        [1, -0.3, 0.1, 0.4],
        [-0.3, 1, 0.2, -0.6],
        [0.1, 0.2, 1, -0.3],
        [0.4, -0.6, -0.3, 1]
      ];

      const trace = {
        z: z, x: params, y: params, type: 'heatmap',
        colorscale: 'Blues', zmin: -1, zmax: 1, showscale: true
      };

      // Annotations
      const annotations = [];
      for (let i = 0; i < params.length; i++) {
        for (let j = 0; j < params.length; j++) {
          annotations.push({
            x: params[j], y: params[i], text: z[i][j].toFixed(1),
            font: { color: Math.abs(z[i][j]) > 0.5 ? 'white' : 'black' },
            showarrow: false
          });
        }
      }

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter, sans-serif', color: theme.text },
        margin: { l: 50, r: 50, t: 20, b: 50 },
        annotations: annotations
      };

      Plotly.newPlot('correlation-chart', [trace], layout, { responsive: true, displayModeBar: false });
    }

    function renderStatusChips() {
      const chips = [
        { l: 'pH', s: 'success', v: '7.4' },
        { l: 'Turbidity', s: 'danger', v: '485' },
        { l: 'Temp', s: 'primary', v: '24.5Â°' },
        { l: 'DO', s: 'warning', v: '5.2' },
      ];
      const html = chips.map(c => `
          <div style="border:1px solid var(--border-color); padding:12px 20px; border-radius:8px; min-width:140px;">
              <div class="text-muted" style="font-size:0.85rem;">${c.l}</div>
              <div style="font-size:1.25rem; font-weight:600; margin-top:4px;">${c.v}</div>
              <span class="status-dot ${c.s === 'danger' ? 'danger' : c.s === 'warning' ? 'warning' : 'success'}" style="display:inline-block; margin-top:8px; width:8px; height:8px; border-radius:50%; background:var(--${c.s});"></span>
          </div>
       `).join('');
      document.getElementById('anomaly-results').innerHTML = html;
    }

    function updateStats() {
      // Mock stats update
      document.getElementById('critical-count').innerText = "3";
      document.getElementById('warning-count').innerText = "8";
      document.getElementById('normal-count').innerText = "85";
    }

    renderHeatmap();
    renderTimeline();
    renderCorrelation();
    renderStatusChips();
    updateStats();

    // Auto-resize charts on window resize
    window.onresize = function () {
      Plotly.Plots.resize('heatmap-chart');
      Plotly.Plots.resize('timeline-chart');
      Plotly.Plots.resize('correlation-chart');
    };
  </script>
</body>

</html>