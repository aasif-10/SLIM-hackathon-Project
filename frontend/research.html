<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Research | SLIM AI</title>
  <link rel="stylesheet" href="css/design-system.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <script src="js/components.js"></script>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>

<body>
  <div id="app-nav" style="display: contents;"></div>

  <main class="main-content">
    <header class="top-bar">
      <div class="page-title">Research Models</div>
      <div class="flex items-center gap-2">
        <span class="badge badge-neutral">Mode: Experimental</span>
      </div>
    </header>

    <div class="scroll-area">
      <div class="container">

        <div class="card mb-4">
          <div class="card-header">
            <div class="card-title">Model Control</div>
          </div>
          <div class="flex justify-between items-center">
            <div>
              <h3 style="font-size:1rem; font-weight:600;">Advanced Lake Ecosystem Analysis</h3>
              <p class="text-muted" style="font-size:0.9rem;">Trigger Graph Neural Networks and Causal Inference
                engines.</p>
            </div>
            <div class="flex items-center gap-3">
              <span id="research-status" class="text-muted" style="font-size:0.85rem;">Ready to compute</span>
              <button id="load-research-btn" class="btn btn-primary">Run Analysis</button>
            </div>
          </div>
        </div>

        <!-- Graph Neural Network Section -->
        <div class="grid-1 mb-4">
          <div class="card">
            <div class="card-header">
              <div class="card-title">GNN Sensor Topology & Risk Propagation</div>
            </div>
            <div class="chart-container-lg" id="gnn-network-chart" style="height: 400px; width:100%;">
              <div class="flex justify-center items-center h-full text-muted">
                Click 'Run Analysis' to visualize network topology
              </div>
            </div>
          </div>
        </div>

        <!-- Forecasts -->
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Bayesian DO Forecast (Probabilistic)</div>
            </div>
            <div id="bayesian-forecast-chart" style="height: 350px; width:100%;"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Multi-Horizon Propagation</div>
            </div>
            <div id="propagation-chart" style="height: 350px; width:100%;"></div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="js/components.js"></script>
  <script>initPage('research');</script>

  <script>
    // V3 Vizu Theme
    const theme = {
      bg: '#ffffff',
      surface: '#ffffff',
      text: '#0f172a',
      muted: '#64748b',
      border: '#e2e8f0',
      primary: '#3b82f6',
      success: '#10b981',
      warning: '#f59e0b',
      danger: '#ef4444',
      purple: '#8b5cf6'
    };

    const loadResearchBtn = document.getElementById('load-research-btn');
    const researchStatus = document.getElementById('research-status');

    function renderGNNNetwork(nodes, edges) {
      // Lake Shape (Simple SVG Path approximation for viz)
      const lakeShape = {
        type: 'path',
        path: 'M 0.2,0.5 Q 0.2,0.8 0.5,0.9 Q 0.8,0.8 0.8,0.5 Q 0.8,0.2 0.5,0.1 Q 0.2,0.2 0.2,0.5 Z',
        fillcolor: 'rgba(59, 130, 246, 0.05)',
        line: { color: 'rgba(59, 130, 246, 0.2)', width: 2 }
      };

      const sensorPositions = {
        'S-01': { x: 0.35, y: 0.8 }, 'S-02': { x: 0.65, y: 0.8 },
        'S-03': { x: 0.85, y: 0.5 }, 'S-04': { x: 0.65, y: 0.2 },
        'S-05': { x: 0.35, y: 0.2 }, 'S-06': { x: 0.15, y: 0.5 }
      };

      const ids = Object.keys(sensorPositions);
      const x = ids.map(k => sensorPositions[k].x);
      const y = ids.map(k => sensorPositions[k].y);

      // Edges
      const edgeX = [], edgeY = [];
      const connections = [['S-01', 'S-02'], ['S-02', 'S-03'], ['S-03', 'S-04'], ['S-04', 'S-05'], ['S-05', 'S-06'], ['S-06', 'S-01'], ['S-01', 'S-04']];

      const edgeTraces = connections.map(c => {
        return {
          x: [sensorPositions[c[0]].x, sensorPositions[c[1]].x],
          y: [sensorPositions[c[0]].y, sensorPositions[c[1]].y],
          mode: 'lines',
          line: { width: 1, color: theme.border },
          type: 'scatter', showlegend: false, hoverinfo: 'none'
        };
      });

      const nodeTrace = {
        x: x, y: y, mode: 'markers+text',
        marker: { size: 24, color: theme.surface, line: { width: 2, color: theme.primary } },
        text: ids, textposition: 'top center',
        type: 'scatter', hoverinfo: 'text'
      };

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter', color: theme.text },
        margin: { l: 20, r: 20, t: 20, b: 20 },
        xaxis: { visible: false, range: [0, 1] },
        yaxis: { visible: false, range: [0, 1] },
        shapes: [lakeShape],
        showlegend: false
      };

      Plotly.newPlot('gnn-network-chart', [...edgeTraces, nodeTrace], layout, { responsive: true, displayModeBar: false });
    }

    function renderBayesianForecast() {
      const x = Array.from({ length: 24 }, (_, i) => i);
      const y = x.map(i => 7 + Math.sin(i / 3));
      const yUpper = y.map(v => v + 0.5);
      const yLower = y.map(v => v - 0.5);

      const trace1 = {
        x: x, y: yUpper, type: 'scatter', mode: 'lines', line: { width: 0 }, showlegend: false, hoverinfo: 'skip'
      };
      const trace2 = {
        x: x, y: yLower, type: 'scatter', mode: 'lines', fill: 'tonexty', fillcolor: 'rgba(59, 130, 246, 0.2)', line: { width: 0 }, showlegend: false, hoverinfo: 'skip'
      };
      const trace3 = {
        x: x, y: y, type: 'scatter', mode: 'lines', line: { color: theme.primary, width: 3 }, name: 'Median'
      };

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter', color: theme.text },
        margin: { l: 40, r: 20, t: 20, b: 40 },
        yaxis: { title: 'DO (mg/L)', gridcolor: theme.border },
        xaxis: { title: 'Hours Ahead' }
      };

      Plotly.newPlot('bayesian-forecast-chart', [trace1, trace2, trace3], layout, { responsive: true, displayModeBar: false });
    }

    function renderPropagation() {
      const sensors = ['S-01', 'S-02', 'S-03', 'S-04', 'S-05', 'S-06'];
      const trace = {
        x: sensors, y: [8.2, 7.9, 7.5, 6.8, 6.5, 7.1],
        type: 'scatter', mode: 'lines+markers',
        line: { color: theme.purple, width: 2 },
        marker: { size: 8, color: theme.bg, line: { width: 2, color: theme.purple } }
      };
      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Inter', color: theme.text },
        margin: { l: 40, r: 20, t: 20, b: 40 },
        yaxis: { title: 'Projected Impact', gridcolor: theme.border },
        xaxis: { gridcolor: 'transparent' }
      };
      Plotly.newPlot('propagation-chart', [trace], layout, { responsive: true, displayModeBar: false });
    }

    loadResearchBtn.addEventListener('click', () => {
      researchStatus.innerText = "Running models...";
      setTimeout(() => {
        renderGNNNetwork();
        renderBayesianForecast();
        renderPropagation();
        researchStatus.innerText = "Analysis Complete";
      }, 800);
    });

    // Initial render empty or shim
  </script>
</body>

</html>