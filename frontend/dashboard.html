<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | SLIM AI</title>
  <link rel="stylesheet" href="css/design-system.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    /* Map specific overrides for clean look */
    .leaflet-container {
      background: #f8fafc;
      font-family: var(--font-sans);
    }

    .custom-popup .leaflet-popup-content-wrapper {
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 0;
    }

    .custom-popup .leaflet-popup-content {
      margin: 0;
    }

    .sensor-popup {
      padding: 12px 16px;
    }

    .sensor-popup h4 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
    }

    .popup-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    /* Buoy Icons (Clean) */
    .buoy-icon {
      width: 14px;
      height: 14px;
      background: var(--success);
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      margin: 0 auto;
    }

    .buoy-icon.warning {
      background: var(--warning);
    }

    .buoy-icon.selected {
      transform: scale(1.4);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
    }

    .buoy-label {
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
      background: rgba(15, 23, 42, 0.8);
      padding: 2px 4px;
      border-radius: 4px;
      margin-top: 4px;
    }

    /* Map Overlay Controls */
    .map-overlay-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .map-btn-sm {
      width: 32px;
      height: 32px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .map-btn-sm:hover {
      background: var(--slate-50);
    }
  </style>
</head>

<body>

  <!-- Sidebar Injector -->
  <div id="app-nav" style="display: contents;"></div>

  <!-- Main Content Area -->
  <main class="main-content">

    <!-- Top Bar -->
    <header class="top-bar">
      <div class="page-title">Monitoring Dashboard</div>
      <div class="flex items-center gap-2">
        <span class="badge badge-success">System Online</span>
        <div id="clock-display" class="text-muted" style="font-size: 0.875rem; font-family: var(--font-mono);">
          00:00:00UTC</div>
      </div>
    </header>

    <!-- Scrollable Content -->
    <div class="scroll-area">
      <div class="container">

        <!-- Insights Row -->
        <div class="grid-3 mb-4" id="insight-grid">
          <!-- Insights injected by JS here -->
          <!-- Fallback Loading State -->
          <div class="card" style="height: 100px; display:flex; align-items:center; justify-content:center;">
            <span class="text-muted">Loading System Context...</span>
          </div>
        </div>

        <div class="grid-3 mb-4">
          <!-- Map Section (Spans 2 columns) -->
          <div class="card"
            style="grid-column: span 2; padding: 0; overflow: hidden; height: 500px; display: flex; flex-direction: column;">
            <div class="card-header"
              style="padding: 16px 24px; border-bottom: 1px solid var(--border-color); margin-bottom:0;">
              <div class="card-title">Sensor Network Map</div>
              <span class="text-muted" style="font-size: 0.8rem;">Ulsoor Lake Sector</span>
            </div>
            <div style="position: relative; flex: 1;">
              <div id="lake-map" style="width: 100%; height: 100%;"></div>

              <!-- Map Controls Overlay -->
              <div class="map-overlay-controls map-controls">
                <button class="map-btn-sm" id="zoom-in-btn" title="Zoom In">+</button>
                <button class="map-btn-sm" id="zoom-out-btn" title="Zoom Out">-</button>
                <button class="map-btn-sm" id="reset-view-btn" title="Reset View">⌂</button>
                <!-- JS appends map type toggle here -->
              </div>

              <div class="map-overlay-controls" style="top: auto; bottom: 12px; right: auto; left: 12px;">
                <div id="zoom-info"
                  style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid var(--border-color);">
                  Zoom: --
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel: Controls & Details -->
          <div class="flex" style="flex-direction: column; gap: 24px;">

            <!-- Command Card -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">Live Controls</div>
                <span class="badge badge-neutral">ESP32</span>
              </div>

              <div class="form-group">
                <div class="label">Sync Options</div>
                <div class="grid-2" style="gap: 12px; margin-bottom: 12px;">
                  <button id="request-reading-btn" class="btn btn-primary" style="width: 100%;">
                    Sync Hardware
                  </button>
                  <button id="load-latest-btn" class="btn btn-secondary" style="width: 100%;">
                    Fetch Cloud
                  </button>
                </div>
                <div id="request-status" class="text-muted" style="font-size: 0.8rem; min-height: 1.2em;">
                  Ready to sync.
                </div>
              </div>

              <!-- Latest Reading Container -->
              <div id="latest-reading"
                style="display: none; background: var(--slate-50); padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--border-color); font-size: 0.85rem;">
                <!-- JS injects here -->
              </div>
            </div>

            <!-- Sensor Detail Card -->
            <div class="card" style="flex: 1;">
              <div class="card-header">
                <div class="card-title">Selected Sensor</div>
              </div>
              <div id="sensor-detail">
                <div style="text-align: center; padding: 40px 0; color: var(--text-muted);">
                  <svg style="width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.5;" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  <p>Select a sensor marker on the map to view real-time metrics.</p>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Historical Charts -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Historical Trends (7 Days)</div>
            <div class="text-muted" style="font-size: 0.8rem;">8 Readings / Day</div>
          </div>
          <div id="trends-chart" style="width: 100%; height: 400px;"></div>
        </div>

        <!-- Data Table -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Recent Measurements Log</div>
            <button class="btn btn-secondary btn-sm" onclick="populateTable()">Refresh Log</button>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table" id="data-table">
              <thead>
                <tr>
                  <th>Sensor ID</th>
                  <th>Timestamp</th>
                  <th class="text-right">Temperature</th>
                  <th class="text-right">pH Level</th>
                  <th class="text-right">Dissolved O₂</th>
                  <th class="text-right">Turbidity</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- JS populates -->
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- JS Dependencies -->
  <script src="js/components.js"></script>
  <script>
    // Initialize Shell
    if (initPage('dashboard')) {
      // Clock
      setInterval(() => {
        document.getElementById('clock-display').innerText = new Date().toISOString().split('T')[1].split('.')[0] + ' UTC';
      }, 1000);
    }
  </script>

  <!-- Legacy Script Logic (Adapted) -->
  <script>
    // We need to ensure the renderLakeInsights function knows the new layout requires cards
    // The previous legacy script had: insightGrid.innerHTML = insights.map(...).join('');
    // It generated .insight-card divs. 
    // Our CSS now expects .card.

    // I will override the renderLakeInsights function or let the legacy script run but fix the CSS classes it generates via a quick patch script or if I paste the whole legacy script here I can modify it.
    // I WILL PASTE THE ESSENTIAL LOGIC FROM THE PREVIOUS FILE HERE TO ENSURE IT WORKS WITH THE NEW CLASSES.

    const requestButton = document.getElementById('request-reading-btn');
    const loadLatestButton = document.getElementById('load-latest-btn');
    const requestStatus = document.getElementById('request-status');
    const latestReadingContainer = document.getElementById('latest-reading');
    const insightGrid = document.getElementById('insight-grid');

    const API_BASE = 'http://127.0.0.1:8000';
    const API_HEADERS = { 'x-api-key': 'password' };
    const apiUrl = (path) => `${API_BASE}${path}`;

    const sensors = [
      { id: 'S-01', name: 'North Shore', x: 32, y: 30, status: 'healthy' },
      { id: 'S-02', name: 'East Bay', x: 72, y: 36, status: 'healthy' },
      { id: 'S-03', name: 'Central Deep', x: 52, y: 50, status: 'healthy' },
      { id: 'S-04', name: 'South Inlet', x: 42, y: 68, status: 'warning' },
      { id: 'S-05', name: 'West Shore', x: 24, y: 56, status: 'healthy' },
      { id: 'S-06', name: 'Outlet Channel', x: 78, y: 62, status: 'healthy' }
    ];

    const sensorData = {
      'S-01': { temp: 18.2, ph: 7.4, oxygen: 8.9, turbidity: 2.1, depth: 12.5, lastUpdate: '3h ago' },
      'S-02': { temp: 18.5, ph: 7.5, oxygen: 9.2, turbidity: 1.8, depth: 15.2, lastUpdate: '3h ago' },
      'S-03': { temp: 17.8, ph: 7.3, oxygen: 8.7, turbidity: 2.4, depth: 22.8, lastUpdate: '3h ago' },
      'S-04': { temp: 19.1, ph: 6.9, oxygen: 7.8, turbidity: 4.2, depth: 8.3, lastUpdate: '3h ago' },
      'S-05': { temp: 18.3, ph: 7.4, oxygen: 9.0, turbidity: 2.2, depth: 10.7, lastUpdate: '3h ago' },
      'S-06': { temp: 18.7, ph: 7.5, oxygen: 8.8, turbidity: 2.6, depth: 14.1, lastUpdate: '3h ago' }
    };

    // --- INSIGHTS RENDERER ---
    function renderLakeInsights() {
      if (!insightGrid) return;
      const values = Object.values(sensorData);
      if (!values.length) return;

      const avg = (arr) => arr.reduce((sum, val) => sum + val, 0) / arr.length;
      const avgTemp = avg(values.map((v) => v.temp)).toFixed(1);
      const avgPh = avg(values.map((v) => v.ph)).toFixed(2);
      const avgTurbidity = avg(values.map((v) => v.turbidity)).toFixed(1);

      const healthyCount = sensors.filter((s) => s.status === 'healthy').length;

      const insights = [
        {
          label: 'Overall Condition',
          value: 'Stable',
          subtext: `Avg Temp ${avgTemp}°C`,
          color: 'success'
        },
        {
          label: 'Avg Turbidity',
          value: `${avgTurbidity} NTU`,
          subtext: avgTurbidity <= 3 ? 'Clear Water' : 'High Particulates',
          color: avgTurbidity <= 3 ? 'success' : 'warning'
        },
        {
          label: 'Network Status',
          value: `${healthyCount}/${sensors.length} Active`,
          subtext: 'All sensors responding',
          color: 'success'
        }
      ];

      insightGrid.innerHTML = insights.map((insight) => `
          <div class="card" style="margin-bottom:0; padding: 20px;">
            <div class="label" style="color: var(--text-muted); text-transform:uppercase; font-size:0.75rem;">${insight.label}</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 4px 0;">${insight.value}</div>
            <div style="font-size: 0.85rem; color: var(--text-muted); display:flex; align-items:center gap:4px;">
                <span style="width:8px; height:8px; border-radius:50%; background:var(--${insight.color}); display:inline-block; margin-right:6px;"></span>
                ${insight.subtext}
            </div>
          </div>
        `).join('');
    }

    // --- MAP LOGIC ---
    let lakeMap = null;
    function initMap() {
      // Ulsoor Lake center
      const lakeCenter = [12.9825, 77.6190];
      lakeMap = L.map('lake-map', {
        center: lakeCenter, zoom: 16, zoomControl: false, attributionControl: false
      });

      // Clean tiles: CartoDB Light
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: 'CartoDB', maxZoom: 19
      }).addTo(lakeMap);

      // Boundary
      const lakeBoundary = [
        [12.9855, 77.6180], [12.9850, 77.6200], [12.9842, 77.6210],
        [12.9828, 77.6212], [12.9815, 77.6205], [12.9808, 77.6190],
        [12.9810, 77.6175], [12.9822, 77.6165], [12.9838, 77.6165],
        [12.9852, 77.6172], [12.9855, 77.6180]
      ];
      L.polygon(lakeBoundary, {
        color: '#3b82f6', weight: 2, opacity: 0.6,
        fillColor: '#3b82f6', fillOpacity: 0.1
      }).addTo(lakeMap);

      // Markers
      sensors.forEach(sensor => {
        const pos = getSensorPos(sensor.id);
        const icon = L.divIcon({
          className: 'custom-buoy-marker',
          html: `<div class="buoy-icon ${sensor.status === 'warning' ? 'warning' : ''}" data-id="${sensor.id}"></div><div class="buoy-label">${sensor.id}</div>`,
          iconSize: [28, 42], iconAnchor: [14, 14]
        });
        const m = L.marker(pos, { icon: icon }).addTo(lakeMap);
        m.on('click', () => selectSensor(sensor.id));
      });

      // Controls
      document.getElementById('zoom-in-btn').addEventListener('click', () => lakeMap.zoomIn());
      document.getElementById('zoom-out-btn').addEventListener('click', () => lakeMap.zoomOut());
      document.getElementById('reset-view-btn').addEventListener('click', () => lakeMap.setView(lakeCenter, 16));

      // Zoom Info
      lakeMap.on('zoomend', () => {
        document.getElementById('zoom-info').innerText = 'Zoom: ' + lakeMap.getZoom();
      });
    }

    function getSensorPos(id) {
      // Hardcoded layout for visuals
      const positions = {
        'S-01': [12.9842, 77.6185], 'S-02': [12.9838, 77.6202],
        'S-03': [12.9828, 77.6188], 'S-04': [12.9815, 77.6185],
        'S-05': [12.9825, 77.6172], 'S-06': [12.9820, 77.6198]
      };
      return positions[id] || [12.9825, 77.6190];
    }

    function selectSensor(id) {
      const s = sensors.find(x => x.id === id);
      const d = sensorData[id];
      if (!s || !d) return;

      // Highlight logic could go here

      document.getElementById('sensor-detail').innerHTML = `
              <div style="padding: 12px 0;">
                  <div class="flex justify-between items-center mb-4">
                      <h3 style="font-size:1.1rem; margin:0;">${s.name}</h3>
                      <span class="badge ${s.status === 'healthy' ? 'badge-success' : 'badge-warning'}">${s.status.toUpperCase()}</span>
                  </div>
                  
                  <div class="grid-2" style="gap: 16px;">
                      <div>
                          <div class="label">Temperature</div>
                          <div style="font-size:1.2rem; font-weight:600;">${d.temp}°C</div>
                      </div>
                      <div>
                          <div class="label">pH Level</div>
                          <div style="font-size:1.2rem; font-weight:600;">${d.ph}</div>
                      </div>
                      <div>
                          <div class="label">Oxygen</div>
                          <div style="font-size:1.2rem; font-weight:600;">${d.oxygen} <span style="font-size:0.8rem; color:var(--text-muted);">mg/L</span></div>
                      </div>
                      <div>
                          <div class="label">Turbidity</div>
                          <div style="font-size:1.2rem; font-weight:600;">${d.turbidity} <span style="font-size:0.8rem; color:var(--text-muted);">NTU</span></div>
                      </div>
                  </div>
                  
                  <div style="margin-top: 16px; padding-top:16px; border-top:1px solid var(--border-color); font-size:0.8rem; color:var(--text-muted);">
                      Last Updated: ${d.lastUpdate} • Depth: ${d.depth}m
                  </div>
              </div>
          `;

      updateChart(id);
    }

    // --- CHART LOGIC ---
    function initChart() { updateChart('S-01'); }

    // Mock Data Generator for Charts
    function generateHistory(baseTemp) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      return days.map(d => ({
        day: d,
        val: baseTemp + (Math.random() * 2 - 1)
      }));
    }

    function updateChart(id) {
      const d = sensorData[id];
      const hist = generateHistory(d.temp);

      const trace1 = {
        x: hist.map(h => h.day),
        y: hist.map(h => h.val),
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: '#3b82f6' },
        line: { color: '#3b82f6', width: 3 }
      };

      const layout = {
        margin: { t: 20, r: 20, b: 40, l: 40 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { showgrid: false },
        yaxis: { gridcolor: '#e2e8f0' }
      };

      Plotly.newPlot('trends-chart', [trace1], layout, { displayModeBar: false });
    }

    // --- TABLE LOGIC ---
    function populateTable() {
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = sensors.map(s => {
        const d = sensorData[s.id];
        return `
                <tr>
                    <td><span style="font-weight:500;">${s.id}</span> <span class="text-muted" style="font-size:0.8rem;">${s.name}</span></td>
                    <td>${new Date().toLocaleTimeString()}</td>
                    <td class="text-right">${d.temp}°C</td>
                    <td class="text-right">${d.ph}</td>
                    <td class="text-right">${d.oxygen}</td>
                    <td class="text-right">${d.turbidity}</td>
                    <td><span class="badge ${s.status === 'healthy' ? 'badge-success' : 'badge-warning'}">${s.status}</span></td>
                </tr>
              `;
      }).join('');
    }

    // --- INIT ---
    initMap();
    renderLakeInsights();
    initChart();
    populateTable();

    // Dummy Listeners for Sync Buttons to prevent errors
    loadLatestButton.addEventListener('click', () => {
      loadLatestButton.innerText = 'Fetching...';
      setTimeout(() => { loadLatestButton.innerText = 'Fetch Cloud'; populateTable(); }, 1000);
    });

  </script>
</body>

</html>