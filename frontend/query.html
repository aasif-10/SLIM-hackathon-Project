<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Query | SLIM AI</title>
  <link rel="stylesheet" href="css/design-system.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <script src="js/components.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div id="app-nav" style="display: contents;"></div>

  <main class="main-content">
    <header class="top-bar">
      <div class="page-title">Query Intelligence</div>
      <div class="flex items-center gap-2">
        <span class="badge badge-neutral">Model: Gemini Pro</span>
      </div>
    </header>

    <div class="scroll-area">
      <div class="container">

        <div class="grid-2">
          <!-- LEFT: Chat Interface -->
          <div class="flex flex-col gap-4">

            <!-- Quick Actions -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">Quick Insights</div>
              </div>
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline query-btn" data-q="What is the current pH level?">Current
                  pH</button>
                <button class="btn btn-sm btn-outline query-btn" data-q="Show the latest turbidity reading.">Turbidity
                  Status</button>
                <button class="btn btn-sm btn-outline query-btn" data-q="How does temp compare to yesterday?">Temp
                  Delta</button>
                <button class="btn btn-sm btn-outline query-btn" data-q="Is the water safe for swimming?">Safety
                  Check</button>
              </div>
            </div>

            <!-- Expert Chat -->
            <div class="card flex-1" style="min-height: 500px; display: flex; flex-direction: column;">
              <div class="card-header border-b border-light flex justify-between items-center">
                <div class="card-title">Ecology Specialist Agent</div>
                <span class="status-dot success" title="Online"></span>
              </div>

              <!-- Messages Area -->
              <div id="chat-messages" class="flex-1 p-4 overflow-y-auto flex flex-col gap-3 scrollbar-hide"
                style="background: var(--slate-50);">
                <div class="flex justify-start">
                  <div
                    class="bg-white border border-slate-200 text-slate-700 rounded-lg p-3 max-w-[85%] shadow-sm text-sm">
                    Hello! I can analyze complex data trends for deep insights. Ask me about the lake's condition or
                    risks.
                  </div>
                </div>
              </div>

              <!-- Input Area -->
              <div class="p-4 border-t border-light bg-white rounded-b-lg">
                <div class="flex gap-2">
                  <input type="text" id="chat-input" class="form-input" placeholder="Ask a complex question..."
                    style="flex:1;">
                  <button id="chat-send-btn" class="btn btn-primary">Ask</button>
                </div>
              </div>
            </div>

          </div>

          <!-- RIGHT: Data Context -->
          <div class="flex flex-col gap-4">

            <!-- Live Answer Context -->
            <div class="card">
              <div class="card-header">
                <div class="card-title">Live Data Context</div>
                <div id="query-status" class="badge badge-neutral">Ready</div>
              </div>
              <div id="query-answer" class="text-sm text-slate-600 leading-relaxed">
                Select a quick insight button or ask a question to see real-time data analysis here.
              </div>
            </div>

            <!-- History Graph -->
            <div class="card flex-1">
              <div class="card-header">
                <div class="card-title">Trend Analysis</div>
                <button id="load-history-btn" class="btn btn-sm btn-outline">Load History</button>
              </div>
              <div style="height: 250px; position: relative; margin-bottom: 16px;">
                <canvas id="historyChart"></canvas>
              </div>
              <!-- Stats Grid -->
              <div id="stat-grid" class="grid-2 gap-2">
                <!-- Stats will populate here -->
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </main>

  <script src="js/components.js"></script>
  <script>initPage('query');</script>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const queryStatus = document.getElementById('query-status');
    let historyChart;

    // Chat UI Functions
    function addMessage(text, type) {
      const div = document.createElement('div');
      div.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = type === 'user'
        ? 'bg-blue-600 text-white rounded-lg p-3 max-w-[85%] shadow-sm text-sm'
        : 'bg-white border border-slate-200 text-slate-700 rounded-lg p-3 max-w-[85%] shadow-sm text-sm';

      bubble.innerHTML = text; // Allow HTML for formatting
      div.appendChild(bubble);
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return bubble;
    }

    async function handleChat() {
      const q = chatInput.value.trim();
      if (!q) return;

      addMessage(q, 'user');
      chatInput.value = '';

      // Mock Response for UI Demo
      addMessage(`
            <strong>Analysis for "${q}"</strong><br>
            Based on the latest sensor readings, the parameters appear stable. 
            There is no indication of critical anomalies at this moment.
            <div class="mt-2 pt-2 border-t border-slate-200 text-xs text-slate-500 font-mono">
                CONFIDENCE: HIGH | SOURCE: LIVE SENSORS
            </div>
        `, 'ai');
    }

    chatSendBtn.addEventListener('click', handleChat);
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChat(); });

    // Quick Queries
    document.querySelectorAll('.query-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const q = btn.dataset.q;
        document.getElementById('query-answer').innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="spinner"></span>
                    <span>Querying live database...</span>
                </div>
            `;
        queryStatus.className = 'badge badge-primary';
        queryStatus.innerText = 'Querying...';

        // Mock Delay
        await new Promise(r => setTimeout(r, 600));

        const mockAnswer = `
                <strong>Latest Reading:</strong> pH is 7.2, Turbidity is 142 NTU.<br>
                This is within the normal range for this time of day.
            `;
        document.getElementById('query-answer').innerHTML = mockAnswer;
        queryStatus.className = 'badge badge-success';
        queryStatus.innerText = 'Updated';
      });
    });

    // History Chart
    document.getElementById('load-history-btn').addEventListener('click', async () => {
      const btn = document.getElementById('load-history-btn');
      btn.disabled = true;
      btn.innerText = 'Loading...';

      // Mock Data
      const labels = Array.from({ length: 10 }, (_, i) => `${12 + i}:00`);
      const data = Array.from({ length: 10 }, () => Math.random() * 10 + 20); // Temp

      const ctx = document.getElementById('historyChart');
      if (historyChart) historyChart.destroy();

      historyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Temperature (°C)',
            data: data,
            borderColor: '#3b82f6',
            tension: 0.4,
            pointBackgroundColor: '#ffffff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: '#e2e8f0' } },
            x: { grid: { display: false } }
          }
        }
      });

      // Mock Stats
      document.getElementById('stat-grid').innerHTML = `
            <div class="p-3 bg-slate-50 border border-slate-200 rounded text-center">
                <div class="text-xs text-muted uppercase">Avg Temp</div>
                <div class="text-lg font-bold text-slate-800">24.5°C</div>
            </div>
             <div class="p-3 bg-slate-50 border border-slate-200 rounded text-center">
                <div class="text-xs text-muted uppercase">Trend</div>
                <div class="text-lg font-bold text-success">Stable</div>
            </div>
        `;

      btn.disabled = false;
      btn.innerText = 'Refresh';
    });

  </script>
</body>

</html>